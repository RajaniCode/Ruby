<!doctype html>
<html lang="en">








<head>
  <title>Ruby on Rails &mdash; This Week in Rails: Improve custom namespace autoloading, Object#with and more!</title>
  <meta charset="utf-8" />
  <meta content="ie=edge" http-equiv="x-ua-compatible" />
  <meta name="handheldfriendly" content="true" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Hi, this is Greg, bringing you the latest changes in the Rails codebase.Lockdown rails app in production for securityCurrent Dockerfile generated by Rails runs as a non-root user which prevents modification of the operating system but leaves wide open all gems and the application itself.This change locks down the application gems and only opens up access to the following directories: db, log, storage, tmp.Improve support for custom namespacesThis patch improves support for custom root namespaces, and consolidates a direction in the design of the integration of Zeitwerk in Rails.There is a great explanation of the why on how on the pull request.Add class name to ActiveModel::MissingAttributeError error messageWhen an attribute is missing the previous message was unclear about which class is missing the attribute, especially when there are multiple classes that could miss the attribute.By adding the class name to the error message, debugging is easier.Fix nullifying association with composite query constraintsGiven a models setup like:class BlogPost &lt; ApplicationRecord  query_constraints :blog_id, :id  has_many :comments, query_constraints: [:blog_id, :blog_post_id]endclass Comment &lt; ApplicationRecord  query_constraints :blog_id, :blog_post_id  belongs_to :blog_post, query_constraints: [:blog_id, :blog_post_id]endWith this change it is now possible to nullify both blog_post.comments = [] and comment.blog_post = nil association which should result in nullification of all parts of the composite query constraints, meaning blog_id and blog_post_id being nil on the affected comments.Make job display_name failsafeThe display_name method is used by a delayed job to log information about it, including failure messages. Whenever a job class is moved or deleted, the instances still scheduled cannot be constantized anymore, caused display_name and hence the log method to raise an exception. In certain cases, e.g. when logging happens in a rescue block, this may have terminated the entire delayed job worker. With this change, the worker handles failed jobs gracefully and continues work, all with appropriate log output.Allow both include and where on PostgreSQL add_indexRecently, support was added for the include option when creating an index in PostgreSQL, however, when using this option in conjunction with the where option - the INCLUDE and WHERE segments where in the incorrect order causing the migration to error.This Pull Request changes there order of the INCLUDE and WHERE segments when adding an index so that the query is valid.It also updates the order they are expected in the create index statement when dumping the schema.Expand rails route search to all table contentThis pull request expands the search field on the rails/info/routes page to also search:  Route name (with or without a _path and _url extension)  HTTP Verb (eg. GET/POST/PUT etc.)  Controller#ActionBefore this change, the search field was restricted to the route paths.Enhance has_secure_password to also generate a password_salt methodWith this change, has_secure_password generates an #{attribute}_salt method that returns the salt used to compute the password digest. The salt will change whenever the password is changed, so it can be used to create single-use password reset tokens with generates_token_for:class User &lt; ActiveRecord::Base  has_secure_password  generates_token_for :password_reset, expires_in: 15.minutes do    password_salt&amp;.last(10)  endendMake irb a railties dependencyThis pull request adds irb to the dependencies of railties so users with older versions of Ruby can benefit from the latest version of irb, instead of being limited to the version bundled with their Ruby installation.Implement Object#withThis pull request adds Object#with to set and restore public attributes around a block:client.timeout # =&gt; 5client.with(timeout: 1) do  client.timeout # =&gt; 1endclient.timeout # =&gt; 5More examples and details about this change can be found on the pull request.You can view the whole list of changes here.We had 30 contributors to the Rails codebase this past week!Until next time!Subscribe to get these updates mailed to you." />

  <meta property="og:site_name" content="Ruby on Rails" />
  <meta property="og:title" content="This Week in Rails: Improve custom namespace autoloading, Object#with and more!" />
  <meta property="og:description" content="Hi, this is Greg, bringing you the latest changes in the Rails codebase.Lockdown rails app in production for securityCurrent Dockerfile generated by Rails runs as a non-root user which prevents modification of the operating system but leaves wide open all gems and the application itself.This change locks down the application gems and only opens up access to the following directories: db, log, storage, tmp.Improve support for custom namespacesThis patch improves support for custom root namespaces, and consolidates a direction in the design of the integration of Zeitwerk in Rails.There is a great explanation of the why on how on the pull request.Add class name to ActiveModel::MissingAttributeError error messageWhen an attribute is missing the previous message was unclear about which class is missing the attribute, especially when there are multiple classes that could miss the attribute.By adding the class name to the error message, debugging is easier.Fix nullifying association with composite query constraintsGiven a models setup like:class BlogPost &lt; ApplicationRecord  query_constraints :blog_id, :id  has_many :comments, query_constraints: [:blog_id, :blog_post_id]endclass Comment &lt; ApplicationRecord  query_constraints :blog_id, :blog_post_id  belongs_to :blog_post, query_constraints: [:blog_id, :blog_post_id]endWith this change it is now possible to nullify both blog_post.comments = [] and comment.blog_post = nil association which should result in nullification of all parts of the composite query constraints, meaning blog_id and blog_post_id being nil on the affected comments.Make job display_name failsafeThe display_name method is used by a delayed job to log information about it, including failure messages. Whenever a job class is moved or deleted, the instances still scheduled cannot be constantized anymore, caused display_name and hence the log method to raise an exception. In certain cases, e.g. when logging happens in a rescue block, this may have terminated the entire delayed job worker. With this change, the worker handles failed jobs gracefully and continues work, all with appropriate log output.Allow both include and where on PostgreSQL add_indexRecently, support was added for the include option when creating an index in PostgreSQL, however, when using this option in conjunction with the where option - the INCLUDE and WHERE segments where in the incorrect order causing the migration to error.This Pull Request changes there order of the INCLUDE and WHERE segments when adding an index so that the query is valid.It also updates the order they are expected in the create index statement when dumping the schema.Expand rails route search to all table contentThis pull request expands the search field on the rails/info/routes page to also search:  Route name (with or without a _path and _url extension)  HTTP Verb (eg. GET/POST/PUT etc.)  Controller#ActionBefore this change, the search field was restricted to the route paths.Enhance has_secure_password to also generate a password_salt methodWith this change, has_secure_password generates an #{attribute}_salt method that returns the salt used to compute the password digest. The salt will change whenever the password is changed, so it can be used to create single-use password reset tokens with generates_token_for:class User &lt; ActiveRecord::Base  has_secure_password  generates_token_for :password_reset, expires_in: 15.minutes do    password_salt&amp;.last(10)  endendMake irb a railties dependencyThis pull request adds irb to the dependencies of railties so users with older versions of Ruby can benefit from the latest version of irb, instead of being limited to the version bundled with their Ruby installation.Implement Object#withThis pull request adds Object#with to set and restore public attributes around a block:client.timeout # =&gt; 5client.with(timeout: 1) do  client.timeout # =&gt; 1endclient.timeout # =&gt; 5More examples and details about this change can be found on the pull request.You can view the whole list of changes here.We had 30 contributors to the Rails codebase this past week!Until next time!Subscribe to get these updates mailed to you." />
  <meta property="og:image" content="http://localhost:4000/assets/images/opengraph.png" />
  <meta property="og:url" content="http://localhost:4000/2023/3/10/this-week-in-rails" />
  <meta property="og:type" content="article" />

  <meta name="twitter:title" content="This Week in Rails: Improve custom namespace autoloading, Object#with and more!" />
  <meta name="twitter:description" content="Hi, this is Greg, bringing you the latest changes in the Rails codebase.Lockdown rails app in production for securityCurrent Dockerfile generated by Rails runs as a non-root user which prevents modification of the operating system but leaves wide open all gems and the application itself.This change locks down the application gems and only opens up access to the following directories: db, log, storage, tmp.Improve support for custom namespacesThis patch improves support for custom root namespaces, and consolidates a direction in the design of the integration of Zeitwerk in Rails.There is a great explanation of the why on how on the pull request.Add class name to ActiveModel::MissingAttributeError error messageWhen an attribute is missing the previous message was unclear about which class is missing the attribute, especially when there are multiple classes that could miss the attribute.By adding the class name to the error message, debugging is easier.Fix nullifying association with composite query constraintsGiven a models setup like:class BlogPost &lt; ApplicationRecord  query_constraints :blog_id, :id  has_many :comments, query_constraints: [:blog_id, :blog_post_id]endclass Comment &lt; ApplicationRecord  query_constraints :blog_id, :blog_post_id  belongs_to :blog_post, query_constraints: [:blog_id, :blog_post_id]endWith this change it is now possible to nullify both blog_post.comments = [] and comment.blog_post = nil association which should result in nullification of all parts of the composite query constraints, meaning blog_id and blog_post_id being nil on the affected comments.Make job display_name failsafeThe display_name method is used by a delayed job to log information about it, including failure messages. Whenever a job class is moved or deleted, the instances still scheduled cannot be constantized anymore, caused display_name and hence the log method to raise an exception. In certain cases, e.g. when logging happens in a rescue block, this may have terminated the entire delayed job worker. With this change, the worker handles failed jobs gracefully and continues work, all with appropriate log output.Allow both include and where on PostgreSQL add_indexRecently, support was added for the include option when creating an index in PostgreSQL, however, when using this option in conjunction with the where option - the INCLUDE and WHERE segments where in the incorrect order causing the migration to error.This Pull Request changes there order of the INCLUDE and WHERE segments when adding an index so that the query is valid.It also updates the order they are expected in the create index statement when dumping the schema.Expand rails route search to all table contentThis pull request expands the search field on the rails/info/routes page to also search:  Route name (with or without a _path and _url extension)  HTTP Verb (eg. GET/POST/PUT etc.)  Controller#ActionBefore this change, the search field was restricted to the route paths.Enhance has_secure_password to also generate a password_salt methodWith this change, has_secure_password generates an #{attribute}_salt method that returns the salt used to compute the password digest. The salt will change whenever the password is changed, so it can be used to create single-use password reset tokens with generates_token_for:class User &lt; ActiveRecord::Base  has_secure_password  generates_token_for :password_reset, expires_in: 15.minutes do    password_salt&amp;.last(10)  endendMake irb a railties dependencyThis pull request adds irb to the dependencies of railties so users with older versions of Ruby can benefit from the latest version of irb, instead of being limited to the version bundled with their Ruby installation.Implement Object#withThis pull request adds Object#with to set and restore public attributes around a block:client.timeout # =&gt; 5client.with(timeout: 1) do  client.timeout # =&gt; 1endclient.timeout # =&gt; 5More examples and details about this change can be found on the pull request.You can view the whole list of changes here.We had 30 contributors to the Rails codebase this past week!Until next time!Subscribe to get these updates mailed to you." />
  <meta name="twitter:image" content="http://localhost:4000/assets/images/opengraph.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@rails" />
  <meta name="twitter:image:alt" content="Ruby on Rails" />

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:4000/2023/3/10/this-week-in-rails"
      },
      "name": "Ruby on Rails",
      "headline": "This Week in Rails: Improve custom namespace autoloading, Object#with and more!",
      "description": "Hi, this is Greg, bringing you the latest changes in the Rails codebase.Lockdown rails app in production for securityCurrent Dockerfile generated by Rails runs as a non-root user which prevents modification of the operating system but leaves wide open all gems and the application itself.This change locks down the application gems and only opens up access to the following directories: db, log, storage, tmp.Improve support for custom namespacesThis patch improves support for custom root namespaces, and consolidates a direction in the design of the integration of Zeitwerk in Rails.There is a great explanation of the why on how on the pull request.Add class name to ActiveModel::MissingAttributeError error messageWhen an attribute is missing the previous message was unclear about which class is missing the attribute, especially when there are multiple classes that could miss the attribute.By adding the class name to the error message, debugging is easier.Fix nullifying association with composite query constraintsGiven a models setup like:class BlogPost &lt; ApplicationRecord  query_constraints :blog_id, :id  has_many :comments, query_constraints: [:blog_id, :blog_post_id]endclass Comment &lt; ApplicationRecord  query_constraints :blog_id, :blog_post_id  belongs_to :blog_post, query_constraints: [:blog_id, :blog_post_id]endWith this change it is now possible to nullify both blog_post.comments = [] and comment.blog_post = nil association which should result in nullification of all parts of the composite query constraints, meaning blog_id and blog_post_id being nil on the affected comments.Make job display_name failsafeThe display_name method is used by a delayed job to log information about it, including failure messages. Whenever a job class is moved or deleted, the instances still scheduled cannot be constantized anymore, caused display_name and hence the log method to raise an exception. In certain cases, e.g. when logging happens in a rescue block, this may have terminated the entire delayed job worker. With this change, the worker handles failed jobs gracefully and continues work, all with appropriate log output.Allow both include and where on PostgreSQL add_indexRecently, support was added for the include option when creating an index in PostgreSQL, however, when using this option in conjunction with the where option - the INCLUDE and WHERE segments where in the incorrect order causing the migration to error.This Pull Request changes there order of the INCLUDE and WHERE segments when adding an index so that the query is valid.It also updates the order they are expected in the create index statement when dumping the schema.Expand rails route search to all table contentThis pull request expands the search field on the rails/info/routes page to also search:  Route name (with or without a _path and _url extension)  HTTP Verb (eg. GET/POST/PUT etc.)  Controller#ActionBefore this change, the search field was restricted to the route paths.Enhance has_secure_password to also generate a password_salt methodWith this change, has_secure_password generates an #{attribute}_salt method that returns the salt used to compute the password digest. The salt will change whenever the password is changed, so it can be used to create single-use password reset tokens with generates_token_for:class User &lt; ActiveRecord::Base  has_secure_password  generates_token_for :password_reset, expires_in: 15.minutes do    password_salt&amp;.last(10)  endendMake irb a railties dependencyThis pull request adds irb to the dependencies of railties so users with older versions of Ruby can benefit from the latest version of irb, instead of being limited to the version bundled with their Ruby installation.Implement Object#withThis pull request adds Object#with to set and restore public attributes around a block:client.timeout # =&gt; 5client.with(timeout: 1) do  client.timeout # =&gt; 1endclient.timeout # =&gt; 5More examples and details about this change can be found on the pull request.You can view the whole list of changes here.We had 30 contributors to the Rails codebase this past week!Until next time!Subscribe to get these updates mailed to you.",
      "url": "http://localhost:4000/2023/3/10/this-week-in-rails",
      "image": "http://localhost:4000/assets/images/opengraph.png",
      "author": {
        "@type": "Person",
        "name": "greg"
      },
      "datePublished": "2023-03-10T00:00:00+05:30"
    }
  </script>
  <script defer data-domain="rubyonrails.org" src="https://plausible.io/js/script.js"></script>
  <link rel="icon" href="/assets/images/favicon.png" />
  <link rel="stylesheet" href="/assets/css/style.css" />
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="The official Ruby on Rails blog">
</head>


<body>


<nav class="nav">
  <a class="nav__logo" href="/" aria-label="Ruby on Rails"></a>

  <input class="nav__checkbox" id="nav__checkbox" type="checkbox" role="button" aria-label="menu" />

  <label class="nav__toggle" for="nav__checkbox">
    <span></span>
  </label>

  <div class="nav__options">
    <div>
      <ul>
        
          
            <li><a href="https://github.com/rails/rails"><span>Source</span></a></li>
          
        
          
            <li><a href="/docs"><span>Docs</span></a></li>
          
        
          
            <li><a href="/community"><span>Community</span></a></li>
          
        
          
            <li><a href="/blog"><span>News</span></a></li>
          
        
      </ul>

      <ul>
        
          
            <li><a href="/world"><span>Events</span></a></li>
          
        
          
            <li><a href="https://jobs.rubyonrails.org"><span>Jobs</span></a></li>
          
        
          
            <li><a href="https://merch.rubyonrails.org"><span>Merch</span></a></li>
          
        
          
            <li><a href="/foundation"><span>Foundation</span></a></li>
          
        
      </ul>
    </div>
  </div>
</nav>


<div class="layout">
  <div class="post common-padding--bottom common-padding--top-small">
    <div class="container">
      <div class="post__headline common-headline">
        <h5>Friday, March 10, 2023</h5>
        <h2>This Week in Rails: Improve custom namespace autoloading, Object#with and more!</h2>

        <h6>Posted by greg</h6>

      </div>
      <div class="post__content common-content common-content--post">
        <p>Hi, this is <a href="https://greg.molnar.io">Greg</a>, bringing you the latest changes in the Rails codebase.</p>

<p><a href="https://github.com/rails/rails/pull/47594">Lockdown rails app in production for security</a><br />
Current Dockerfile generated by Rails runs as a non-root user which prevents modification of the operating system but leaves wide open all gems and the application itself.
This change locks down the application gems and only opens up access to the following directories: db, log, storage, tmp.</p>

<p><a href="https://github.com/rails/rails/pull/47583">Improve support for custom namespaces</a><br />
This patch improves support for custom root namespaces, and consolidates a direction in the design of the integration of Zeitwerk in Rails.
There is a great explanation of the why on how on the pull request.</p>

<p><a href="https://github.com/rails/rails/pull/47569">Add class name to ActiveModel::MissingAttributeError error message</a><br />
When an attribute is missing the previous message was unclear about which class is missing the attribute, especially when there are multiple classes that could miss the attribute.
By adding the class name to the error message, debugging is easier.</p>

<p><a href="https://github.com/rails/rails/pull/47565">Fix nullifying association with composite query constraints</a><br />
Given a models setup like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BlogPost</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">query_constraints</span> <span class="ss">:blog_id</span><span class="p">,</span> <span class="ss">:id</span>

  <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">query_constraints: </span><span class="p">[</span><span class="ss">:blog_id</span><span class="p">,</span> <span class="ss">:blog_post_id</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">query_constraints</span> <span class="ss">:blog_id</span><span class="p">,</span> <span class="ss">:blog_post_id</span>

  <span class="n">belongs_to</span> <span class="ss">:blog_post</span><span class="p">,</span> <span class="ss">query_constraints: </span><span class="p">[</span><span class="ss">:blog_id</span><span class="p">,</span> <span class="ss">:blog_post_id</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>
<p>With this change it is now possible to nullify both <code class="language-plaintext highlighter-rouge">blog_post.comments = []</code> and <code class="language-plaintext highlighter-rouge">comment.blog_post = nil</code> association which should result in nullification of all parts of the composite query constraints, meaning <code class="language-plaintext highlighter-rouge">blog_id</code> and <code class="language-plaintext highlighter-rouge">blog_post_id</code> being <code class="language-plaintext highlighter-rouge">nil</code> on the affected comments.</p>

<p><a href="https://github.com/rails/rails/pull/47556">Make job display_name failsafe</a><br />
The <code class="language-plaintext highlighter-rouge">display_name</code> method is used by a delayed job to log information about it, including failure messages. Whenever a job class is moved or deleted, the instances still scheduled cannot be constantized anymore, caused <code class="language-plaintext highlighter-rouge">display_name</code> and hence the log method to raise an exception. In certain cases, e.g. when logging happens in a rescue block, this may have terminated the entire delayed job worker. With this change, the worker handles failed jobs gracefully and continues work, all with appropriate log output.</p>

<p><a href="https://github.com/rails/rails/pull/47552">Allow both include and where on PostgreSQL add_index</a><br />
Recently, support was added for the <code class="language-plaintext highlighter-rouge">include</code> option when creating an index in PostgreSQL, however, when using this option in conjunction with the <code class="language-plaintext highlighter-rouge">where</code> option - the INCLUDE and WHERE segments where in the incorrect order causing the migration to error.
This Pull Request changes there order of the INCLUDE and WHERE segments when adding an index so that the query is valid.
It also updates the order they are expected in the create index statement when dumping the schema.</p>

<p><a href="https://github.com/rails/rails/pull/47532">Expand rails route search to all table content</a><br />
This pull request expands the search field on the rails/info/routes page to also search:</p>

<ul>
  <li>Route name (with or without a _path and _url extension)</li>
  <li>HTTP Verb (eg. GET/POST/PUT etc.)</li>
  <li>Controller#Action</li>
</ul>

<p>Before this change, the search field was restricted to the route paths.</p>

<p><a href="https://github.com/rails/rails/pull/47490">Enhance has_secure_password to also generate a password_salt method</a></p>

<p>With this change, <code class="language-plaintext highlighter-rouge">has_secure_password</code> generates an <code class="language-plaintext highlighter-rouge">#{attribute}_salt</code> method that returns the salt used to compute the password digest. The salt will change whenever the password is changed, so it can be used to create single-use password reset tokens with <code class="language-plaintext highlighter-rouge">generates_token_for</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_secure_password</span>
  <span class="n">generates_token_for</span> <span class="ss">:password_reset</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">15</span><span class="p">.</span><span class="nf">minutes</span> <span class="k">do</span>
    <span class="n">password_salt</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">last</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><a href="https://github.com/rails/rails/pull/47442">Make irb a railties dependency</a><br />
This pull request adds irb to the dependencies of railties so users with older versions of Ruby can benefit from the latest version of irb, instead of being limited to the version bundled with their Ruby installation.</p>

<p><a href="https://github.com/rails/rails/pull/46681">Implement Object#with</a><br />
This pull request adds <code class="language-plaintext highlighter-rouge">Object#with</code> to set and restore public attributes around a block:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span><span class="p">.</span><span class="nf">timeout</span> <span class="c1"># =&gt; 5</span>
<span class="n">client</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">timeout: </span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">client</span><span class="p">.</span><span class="nf">timeout</span> <span class="c1"># =&gt; 1</span>
<span class="k">end</span>
<span class="n">client</span><span class="p">.</span><span class="nf">timeout</span> <span class="c1"># =&gt; 5</span>
</code></pre></div></div>
<p>More examples and details about this change can be found on the pull request.</p>

<p><em>You can view the whole list of changes <a href="https://github.com/rails/rails/compare/@%7B2023-03-03%7D...main@%7B2023-03-10%7D">here</a>.</em>
<em>We had <a href="https://contributors.rubyonrails.org/contributors/in-time-window/20230303-20230310">30 contributors</a> to the Rails codebase this past week!</em></p>

<p>Until next time!</p>

<p><em><a href="https://world.hey.com/this.week.in.rails">Subscribe</a> to get these updates mailed to you.</em></p>

      </div>
    </div>
  </div>
</div>

<footer class="footer common-background--grey common-padding--bottom common-padding--top common-shape--top-white-up-left">
  <div class="footer__logo"><a href="/" aria-label="Ruby on Rails"></a></div>

  
</footer>

</body>
</html>
