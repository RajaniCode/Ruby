<!doctype html>
<html lang="en">








<head>
  <title>Ruby on Rails &mdash; Potential XSS Vulnerability in Ruby on Rails Applications</title>
  <meta charset="utf-8" />
  <meta content="ie=edge" http-equiv="x-ua-compatible" />
  <meta name="handheldfriendly" content="true" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="The XSS prevention support in recent versions Ruby on Rails allows some string operations which, when combined with user supplied data, may leave an ‘unsafe string’ incorrectly considered safe.  It is unlikely that applications call these methods, however we are shipping new versions today which prevent their use to ensure they’re not called unintentionally." />

  <meta property="og:site_name" content="Ruby on Rails" />
  <meta property="og:title" content="Potential XSS Vulnerability in Ruby on Rails Applications" />
  <meta property="og:description" content="The XSS prevention support in recent versions Ruby on Rails allows some string operations which, when combined with user supplied data, may leave an ‘unsafe string’ incorrectly considered safe.  It is unlikely that applications call these methods, however we are shipping new versions today which prevent their use to ensure they’re not called unintentionally." />
  <meta property="og:image" content="http://localhost:4000/assets/images/opengraph.png" />
  <meta property="og:url" content="http://localhost:4000/2011/6/8/potential-xss-vulnerability-in-ruby-on-rails-applications" />
  <meta property="og:type" content="article" />

  <meta name="twitter:title" content="Potential XSS Vulnerability in Ruby on Rails Applications" />
  <meta name="twitter:description" content="The XSS prevention support in recent versions Ruby on Rails allows some string operations which, when combined with user supplied data, may leave an ‘unsafe string’ incorrectly considered safe.  It is unlikely that applications call these methods, however we are shipping new versions today which prevent their use to ensure they’re not called unintentionally." />
  <meta name="twitter:image" content="http://localhost:4000/assets/images/opengraph.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@rails" />
  <meta name="twitter:image:alt" content="Ruby on Rails" />

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:4000/2011/6/8/potential-xss-vulnerability-in-ruby-on-rails-applications"
      },
      "name": "Ruby on Rails",
      "headline": "Potential XSS Vulnerability in Ruby on Rails Applications",
      "description": "The XSS prevention support in recent versions Ruby on Rails allows some string operations which, when combined with user supplied data, may leave an ‘unsafe string’ incorrectly considered safe.  It is unlikely that applications call these methods, however we are shipping new versions today which prevent their use to ensure they’re not called unintentionally.",
      "url": "http://localhost:4000/2011/6/8/potential-xss-vulnerability-in-ruby-on-rails-applications",
      "image": "http://localhost:4000/assets/images/opengraph.png",
      "author": {
        "@type": "Person",
        "name": "aaronp"
      },
      "datePublished": "2011-06-08T20:21:00+05:30"
    }
  </script>
  <script defer data-domain="rubyonrails.org" src="https://plausible.io/js/script.js"></script>
  <link rel="icon" href="/assets/images/favicon.png" />
  <link rel="stylesheet" href="/assets/css/style.css" />
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="The official Ruby on Rails blog">
</head>


<body>


<nav class="nav">
  <a class="nav__logo" href="/" aria-label="Ruby on Rails"></a>

  <input class="nav__checkbox" id="nav__checkbox" type="checkbox" role="button" aria-label="menu" />

  <label class="nav__toggle" for="nav__checkbox">
    <span></span>
  </label>

  <div class="nav__options">
    <div>
      <ul>
        
          
            <li><a href="https://github.com/rails/rails"><span>Source</span></a></li>
          
        
          
            <li><a href="/docs"><span>Docs</span></a></li>
          
        
          
            <li><a href="/community"><span>Community</span></a></li>
          
        
          
            <li><a href="/blog"><span>News</span></a></li>
          
        
      </ul>

      <ul>
        
          
            <li><a href="/world"><span>Events</span></a></li>
          
        
          
            <li><a href="https://jobs.rubyonrails.org"><span>Jobs</span></a></li>
          
        
          
            <li><a href="https://merch.rubyonrails.org"><span>Merch</span></a></li>
          
        
          
            <li><a href="/foundation"><span>Foundation</span></a></li>
          
        
      </ul>
    </div>
  </div>
</nav>


<div class="layout">
  <div class="post common-padding--bottom common-padding--top-small">
    <div class="container">
      <div class="post__headline common-headline">
        <h5>Wednesday, June 8, 2011</h5>
        <h2>Potential XSS Vulnerability in Ruby on Rails Applications</h2>

        <h6>Posted by aaronp</h6>

      </div>
      <div class="post__content common-content common-content--post">
        <p>The XSS prevention support in recent versions Ruby on Rails allows some string operations which, when combined with user supplied data, may leave an ‘unsafe string’ incorrectly considered safe.  It is unlikely that applications call these methods, however we are shipping new versions today which prevent their use to ensure they’re not called unintentionally.</p>

<h2 id="how-the-xss-prevention-works">How the XSS Prevention Works</h2>

<p>When strings are rendered to the client, if the string is not marked as “html safe”, the string will be automatically escaped and marked as “html safe”. Some helper methods automatically return strings already marked as safe.</p>

<p>For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= link_to('hello world', @user) %&gt;
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">link_to</code> method will return a string marked as html safe.  Since <code class="language-plaintext highlighter-rouge">link_to</code> returns an “html safe” string (also known as a safe buffer), the text will be output directly, meaning the user sees a link tag rather than escaped HTML.</p>

<h2 id="the-problem">The Problem</h2>

<p>Safe buffers are allowed to be mutated in place via methods like <code class="language-plaintext highlighter-rouge">sub!</code>.  These methods can add unsafe strings to a safe buffer, and the safe buffer will continue to be marked safe.</p>

<p>An example problem would be something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= link_to('hello world', @user).sub!(/hello/, params[:xss])  %&gt;
</code></pre></div></div>

<p>In the above example, an untrusted string (<code class="language-plaintext highlighter-rouge">params[:xss]</code>) is added to the safe buffer returned by <code class="language-plaintext highlighter-rouge">link_to</code>, and the untrusted content is successfully sent to the client without being escaped.  To prevent this from happening <code class="language-plaintext highlighter-rouge">sub!</code> and other similar methods will now raise an exception when they are called on a safe buffer.</p>

<p>In addition to the in-place versions, some of the versions of these methods which return a copy of the string will incorrectly mark strings as safe.  For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= link_to('hello world', @user).sub(/hello/, params[:xss]) %&gt;
</code></pre></div></div>

<p>The new versions will now ensure that <em>all</em> strings returned by these methods on safe buffers are marked unsafe.</p>
<h2 id="affected-versions">Affected versions</h2>

<p>This problem affects all versions of rails: 3.1.0.rc1, 3.0.7, and 2.3.11.</p>

<h2 id="the-solution">The Solution</h2>

<p>Any methods that mutate the safe buffer without escaping input will now raise an exception.</p>

<p>If you need to modify a safe buffer, cast it to a Ruby string first by calling the <code class="language-plaintext highlighter-rouge">to_str</code> method:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= link_to('hello world', @user).to_str.sub!(/hello/, params[:xss]) %&gt;
</code></pre></div></div>

<h2 id="upgrading">Upgrading</h2>

<p>This problem is fixed in Rails 3.1.0.rc2, 3.0.8, and 2.3.12 (with <code class="language-plaintext highlighter-rouge">rails_xss</code>).  If for some reason you cannot upgrade your Rails installation, please apply these patches:</p>

<ul>
  <li><a href="https://gist.github.com/89d6266cc7875614c5a5">For 3.1.0.rc1</a></li>
  <li><a href="https://gist.github.com/b2ceb626fc2bcdfe497f">For 3.0.7</a></li>
  <li><a href="https://gist.github.com/392235903426322e0414">For 2.3.11, specifically the rails_xss plugin</a></li>
</ul>

<h2 id="thanks">Thanks</h2>

<p>Thanks to Bruno Michel of LinuxFr.org and Brett Valantine who each independently reported the issue to us.</p>

      </div>
    </div>
  </div>
</div>

<footer class="footer common-background--grey common-padding--bottom common-padding--top common-shape--top-white-up-left">
  <div class="footer__logo"><a href="/" aria-label="Ruby on Rails"></a></div>

  
</footer>

</body>
</html>
